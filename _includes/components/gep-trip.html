<style>
  .carousel-container {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    margin: 1vh 0 2vh 0;
  }

  .carousel-img-container {
    width: 63vw;
    overflow: hidden;
    white-space: nowrap;
    font-size: 0; /* removes extra margin between images */
  }

  .carousel-img {
    width: 20vw;
    aspect-ratio: 4/3;
    --transform-width: 21vw;
    object-fit: cover;
    margin: 0vw 0.5vw;
    padding: 0;
    transition: transform 0.25s ease-out;
    border-radius: 10px;
  }

  @media only screen and (max-width: 1250px) {
    .carousel-img-container { width: 62vw; }
    .carousel-img { width: 30vw; --transform-width: 31vw; }
  }
  @media only screen and (max-width: 750px) {
    .carousel-img-container { width: 61vw; }
    .carousel-img { width: 60vw; --transform-width: 61vw; }
  }

  .carousel-img-container.no-transition .carousel-img {
    transition: transform 0s;
  }

  .arrow-container {
    display: flex;
    padding: 0;
    margin: 5vw;
    user-select: none;
  }

  .arrow-container:hover {
    cursor: pointer;
    filter: drop-shadow(0px 0px 5px black);
  }

  .arrow-container.hidden {
    visibility: hidden; /* keep spacing */
    pointer-events: none;
    filter: none;
  }
</style>

<div>
  {% assign data = site.data.gep %}
  {% for row in data %}
    {% assign title = row["GEP"] | default: "" | strip %}
    {% assign writeup = row["write_up"] | default: "" | strip %}
    {% assign photos_raw = row["photos"] | default: "" | strip %}

    {% if title != "" %}
      <h2>{{ title }}</h2>
      {% if writeup != "" %}<p>{{ writeup }}</p>{% endif %}

      {% assign photos = photos_raw | split: "|" %}
      {% assign clean_photos = "" | split: "|" %}
      {% for p in photos %}
        {% assign pt = p | strip %}
        {% if pt != "" %}
          {% assign clean_photos = clean_photos | push: pt %}
        {% endif %}
      {% endfor %}

      {% if clean_photos.size > 0 %}
        <div class="carousel-container">
          <div class="arrow-container left-arrow" aria-label="Previous photos">
            <svg width="14" height="37" viewBox="0 0 28 74" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M24 4L4 37L24 70" stroke="#00664F" stroke-width="7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>

          <div class="carousel-img-container" data-num-original="{{ clean_photos.size }}">
            {% for p in clean_photos %}
              <img src="{{ p | relative_url }}" class="carousel-img" alt="{{ title }} photo {{ forloop.index }}">
            {% endfor %}
          </div>

          <div class="arrow-container right-arrow" aria-label="Next photos">
            <svg width="14" height="37" viewBox="0 0 28 74" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4 4L24 37L4 70" stroke="#00664F" stroke-width="7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
      {% endif %}
    {% endif %}
  {% endfor %}
</div>

<script>
  (() => {
    document.querySelectorAll(".carousel-img-container").forEach(cont => {
      const originalCount = parseInt(cont.dataset.numOriginal || cont.children.length, 10);
      const carousel = cont.parentElement; // .carousel-container
      const leftArrow = carousel.querySelector(".left-arrow");
      const rightArrow = carousel.querySelector(".right-arrow");
      const allImgs = () => Array.from(cont.querySelectorAll(".carousel-img"));

      // 0 or 1 image: no carousel behaviour needed
      if (originalCount <= 1) {
        leftArrow.classList.add("hidden");
        rightArrow.classList.add("hidden");
        cont.setAttribute("shown", "0");
        return;
      }

      // Clone k images for smooth looping; k = min(3, originalCount)
      const k = Math.min(3, originalCount);
      for (let i = 0; i < k; i++) {
        cont.appendChild(cont.children[i].cloneNode(true));
      }

      cont.setAttribute("shown", "0");

      function setShown(shown, withTransition = true) {
        if (!withTransition) cont.classList.add("no-transition");

        allImgs().forEach(img => {
          img.style.transform = `translateX(calc(var(--transform-width) * -${shown}))`;
        });

        if (!withTransition) {
          void cont.offsetHeight; // reflow
          cont.classList.remove("no-transition");
        }

        cont.setAttribute("shown", String(shown));
      }

      rightArrow.addEventListener("click", () => {
        if (cont.hasAttribute("scrolling")) return;
        cont.setAttribute("scrolling", "1");

        let shown = parseInt(cont.getAttribute("shown"), 10);
        let next = shown + 1;

        setShown(next, true);

        // Snap back to 0 after reaching end of originals
        if (next === originalCount) {
          setTimeout(() => {
            setShown(0, false);
            cont.removeAttribute("scrolling");
          }, 290);
        } else {
          setTimeout(() => cont.removeAttribute("scrolling"), 290);
        }
      });

      leftArrow.addEventListener("click", () => {
        if (cont.hasAttribute("scrolling")) return;
        cont.setAttribute("scrolling", "1");

        let shown = parseInt(cont.getAttribute("shown"), 10);
        let next = shown - 1;

        if (next === -1) {
          // Jump to cloned position, then animate to last real item
          setShown(originalCount, false);
          next = originalCount - 1;

          setTimeout(() => {
            setShown(next, true);
            cont.removeAttribute("scrolling");
          }, 10);
        } else {
          setShown(next, true);
          setTimeout(() => cont.removeAttribute("scrolling"), 290);
        }
      });
    });
  })();
</script>
